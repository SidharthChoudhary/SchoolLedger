{% extends "website/base.html" %}
{% block title %}Expenses{% endblock %}
{% block content %}

<h2 style="margin-top:0;">Expenses</h2>

<div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
	<a href="{% url 'bulk_import_ledger' %}" style="display: inline-block; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; background: var(--teal-700); color: white; text-decoration: none; font-size: 14px;">
		üì§ Bulk Import Ledger Entries
	</a>
	<a href="{% url 'export_expenses_csv' %}" style="display: inline-block; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; background: #059669; color: white; text-decoration: none; font-size: 14px;">
		‚¨áÔ∏è Export to CSV
	</a>
	<a href="{% url 'delete_all_expenses' %}" style="display: inline-block; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; background: #dc2626; color: white; text-decoration: none; font-size: 14px;">
		üóëÔ∏è Delete All
	</a>
</div>

<!-- TOP PANEL: one-line data entry -->
{% if show_add %}
<h4 class="form-section">Add Expense - </h4>
	<div class="card" style="margin-bottom:14px;">
	    <form method="post">
				{% csrf_token %}
				{% if editing_entry %}
				<input type="hidden" name="entry_id" value="{{ editing_entry.id }}">
					{% endif %}
						<div class="entry-panels" style="display:flex;flex-direction:column;gap:12px;align-items:flex-start;width:100%;">
						<!-- Panel 1: Session + heads -->
						<div style="width:100%;min-width:320px;border:1px solid #e5e7eb;border-radius:8px;padding:10px;background:#fbfbfc;">
								<div style="display:flex;flex-wrap:nowrap;gap:8px;overflow-x:auto;">
								<div class="field" style="min-width:160px;"><label>Session</label>{{ form.session }}</div>
								<div class="field" style="min-width:160px;"><label>Major Head</label>{{ form.major_head }}</div>
								<div class="field" style="min-width:160px;"><label>Head</label>{{ form.head }}</div>
								<div class="field" style="min-width:160px;"><label>Sub-Head</label>{{ form.sub_head }}</div>
								</div>
						</div>
						<!-- Panel 3: Voucher, Date, Amount, Transaction Type, Remark + Submit -->
						<div style="width:100%;min-width:320px;border:1px solid #e5e7eb;border-radius:8px;padding:10px;background:#fbfbfc;">
						        <div style="display:flex;flex-wrap:nowrap;gap:8px;overflow-x:auto;align-items:flex-end;">
								<div class="field" style="min-width:180px;"><label>Voucher</label>{{ form.voucher_number }}</div>
								<div class="field" style="min-width:140px;"><label>Date</label>{{ form.date }}</div>
								<div class="field" style="min-width:140px;"><label>Amount</label>{{ form.amount }}</div>
								<div class="field" style="min-width:200px;"><label>Details</label>{{ form.details }}</div>
								<div class="field" style="min-width:140px;"><label>Transaction Type</label>{{ form.payment_type }}</div>
								<div class="field field-btn" style="min-width:120px; margin-top:0;">
									<label>&nbsp;</label>
									<button type="submit">{% if editing_entry %}Update{% else %}Save{% endif %}</button>
								</div>
							</div>
						</div>
					</div>
					{% if editing_entry %}
					<div style="margin-top:10px;">
						<a href="{% url 'expenses_home' %}">Cancel Edit</a>
					</div>
					{% endif %}
				</form>
			</div>
{% endif %}

<!-- SEARCH PANEL: Filter Transactions -->
<h3 class="form-section">Search Transactions</h3>
<div style="margin: 8px 0 14px; color:#6b7280; font-size:13px;">
	Total Amount: <b>{{ month_total }}</b>
</div>

<form method="get" style="margin: 10px 0 14px; display:flex; gap:12px; align-items:end; flex-wrap:wrap; background: #fbfbfc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;">
	<div>
		<label style="font-size:12px; font-weight:700;">Session</label>
		<br>
		<select name="session" style="height:40px;">
			<option value="">All</option>
			{% for s in session_choices %}
				<option value="{{ s.id }}" {% if selected_session == s.id|stringformat:"s" %}selected{% endif %}>{{ s.session }}</option>
			{% endfor %}
		</select>
	</div>

	<div>
		<label style="font-size:12px; font-weight:700;">Month</label>
		<br>
		<input type="month" name="month" value="{{ filter_month }}" style="height:40px;">
	</div>

	<div>
		<label style="font-size:12px; font-weight:700;">Major Head</label>
		<br>
		<select name="major_head" style="height:40px;">
			<option value="">All</option>
			{% for mh in major_heads %}
				{% if mh %}<option value="{{ mh }}" {% if selected_major_head == mh %}selected{% endif %}>{{ mh }}</option>{% endif %}
			{% endfor %}
		</select>
	</div>

	<div>
		<label style="font-size:12px; font-weight:700;">Head</label>
		<br>
		<select name="head" style="height:40px;">
			<option value="">All</option>
		</select>
	</div>

	<div>
		<label style="font-size:12px; font-weight:700;">Sub-Head</label>
		<br>
		<select name="sub_head" style="height:40px;">
			<option value="">All</option>
		</select>
	</div>

	<div>
		<button type="submit" style="height:40px;">Apply</button>
		<a href="{% url 'expenses_home' %}" style="margin-left:10px;">Clear</a>
	</div>
</form>
        
          
				<!-- BOTTOM PANEL: saved data -->
				<div class="card">
	            <h3 class="form-section">Transactions</h3>
					{% if entries %}
					<table>
						<tr>
		                	<th>No.</th>
							<th>Session</th>
							<th>Major Head</th>
							<th>Head</th>
							<th>Sub-Head</th>
							<th>Voucher</th>
							<th>Date</th>
							<th>Amount</th>
							<th>Details</th>
							<th>Transaction Type</th>
							<th>Actions</th>
						</tr>
						{% for e in entries %}
						<tr>
		                			<td>{{ forloop.counter }}</td>
									<td>{% if e.session %}{{ e.session.session }}{% endif %}</td>
									<td>{{ e.major_head }}</td>
									<td>{{ e.head }}</td>
									<td>{{ e.sub_head }}</td>
									<td>{{ e.voucher_number }}</td>
									<td>{{ e.date }}</td>
									<td class="amount">{{ e.amount }}</td>
									<td>{{ e.details }}</td>
									<td>{{ e.payment_type }}</td>
									<td class="actions">
										<a class="btn-edit" href="{% url 'expenses_home' %}?edit={{ e.id }}{% if filter_month %}&month={{ filter_month }}{% endif %}{% if filter_name %}&name={{ filter_name }}{% endif %}">Edit</a>
										<a class="btn-delete"
										   onclick="return confirm('Delete this transaction?')"
										   href="{% url 'delete_expense' e.id %}">Delete</a>
									</td>
								</tr>
						{% endfor %}
					</table>
					{% else %}
					<p>No records yet.</p>
					{% endif %}
				</div>
				<script>
			document.addEventListener('DOMContentLoaded', function() {
				const headData = {{ head_data_json|safe }};
				
				function setOptions(selectEl, data, emptyVal) {
					selectEl.innerHTML = '<option value="">' + emptyVal + '</option>';
					
					if (Array.isArray(data)) {
						data.forEach(item => {
							const opt = document.createElement('option');
							opt.value = item;
							opt.textContent = item;
							selectEl.appendChild(opt);
						});
					} else if (typeof data === 'object' && data !== null) {
						for (const [val] of Object.entries(data)) {
							const opt = document.createElement('option');
							opt.value = val;
							opt.textContent = val;
							selectEl.appendChild(opt);
						}
					}
				}

				// Handle filter form (method="get") for Search Transactions
				const filterForm = document.querySelector('form[method="get"]');
				if (filterForm) {
					const filterMajor = filterForm.querySelector('[name="major_head"]');
					const filterHead = filterForm.querySelector('[name="head"]');
					const filterSub = filterForm.querySelector('[name="sub_head"]');
					
					if (filterMajor && filterHead && filterSub) {
						filterMajor.addEventListener('change', function() {
							const major = this.value;
							filterHead.value = '';
							filterSub.innerHTML = '<option value="">All</option>';
							if (major && headData.Expense && headData.Expense[major]) {
								setOptions(filterHead, headData.Expense[major], 'All');
							} else {
								filterHead.innerHTML = '<option value="">All</option>';
							}
						});

						filterHead.addEventListener('change', function() {
							const major = filterMajor.value;
							const head = this.value;
							filterSub.value = '';
							if (major && head && headData.Expense && headData.Expense[major] && headData.Expense[major][head]) {
								setOptions(filterSub, headData.Expense[major][head], 'All');
							} else {
								filterSub.innerHTML = '<option value="">All</option>';
							}
						});
					}
				}

				// Handle entry form (method="post") for Add Expense
				const entryForm = document.querySelector('form[method="post"]');
				if (entryForm) {
					const majorSel = entryForm.querySelector('[name="major_head"]');
					const headSel = entryForm.querySelector('[name="head"]');
					const subSel = entryForm.querySelector('[name="sub_head"]');
					
					if (majorSel && headSel && subSel) {
						majorSel.addEventListener('change', function() {
							const major = this.value;
							headSel.value = '';
							subSel.innerHTML = '<option value="">-- Select --</option>';
							if (major && headData.Expense && headData.Expense[major]) {
								setOptions(headSel, headData.Expense[major], '-- Select --');
							} else {
								headSel.innerHTML = '<option value="">-- Select --</option>';
							}
						});

						headSel.addEventListener('change', function() {
							const major = majorSel.value;
							const head = this.value;
							subSel.value = '';
							if (major && head && headData.Expense && headData.Expense[major] && headData.Expense[major][head]) {
								setOptions(subSel, headData.Expense[major][head], '-- Select --');
							} else {
								subSel.innerHTML = '<option value="">-- Select --</option>';
							}
						});

						if (majorSel.value) {
							majorSel.dispatchEvent(new Event('change'));
						}
					}
				}
			});
		</script>
{% endblock %}
