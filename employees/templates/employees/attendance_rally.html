{% extends "website/base.html" %}
{% load custom_filters %}
{% block title %}Employee Attendance{% endblock %}
{% block content %}

<h2 style="margin-top:0;">Employee Attendance</h2>

<div class="card" style="margin-bottom:14px;">
  <form method="get">
    {% csrf_token %}
    <div class="entry-grid">
      <div class="field">
        <label for="date">Select Date</label>
        <input type="date" name="date" id="date" value="{{ selected_date_str }}" class="form-control" onchange="this.form.submit();">
      </div>
    </div>
  </form>
</div>

{% if messages %}
<div class="messages">
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}
</div>
{% endif %}

{% if current_session %}
<div class="card">
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="session" value="{{ current_session.id }}">
    <input type="hidden" name="date" value="{{ selected_date }}">
    
    <h3 class="form-section">Submit Attendance for {{ selected_date|date:"l, d-M-Y" }}</h3>
    
    {% if employees %}
    <div class="attendance-rally-table">
      <div class="attendance-header">
        <div class="emp-name">Employee Name</div>
        <div class="emp-attendance">Present</div>
        <div class="emp-attendance">Absent</div>
        <div class="emp-attendance">Half Day</div>
      </div>
      
      {% for employee in employees %}
      <div class="attendance-row" id="row_{{ employee.id }}">
        <div class="emp-name">
          <strong>{{ employee.name }}</strong>
        </div>
        
        <div class="emp-attendance">
          <input type="radio" name="attendance_{{ employee.id }}" 
                 value="present" id="present_{{ employee.id }}"
                 {% if attendance_records|get_item:employee.id == 'present' %}checked{% endif %} 
                 onchange="updateRowColor({{ employee.id }})"
                 required>
        </div>
        
        <div class="emp-attendance">
          <input type="radio" name="attendance_{{ employee.id }}" 
                 value="absent" id="absent_{{ employee.id }}"
                 {% if attendance_records|get_item:employee.id == 'absent' %}checked{% endif %}
                 onchange="updateRowColor({{ employee.id }})">
        </div>
        
        <div class="emp-attendance">
          <input type="radio" name="attendance_{{ employee.id }}" 
                 value="half-day" id="half_{{ employee.id }}"
                 {% if attendance_records|get_item:employee.id == 'half-day' %}checked{% endif %}
                 onchange="updateRowColor({{ employee.id }})">
        </div>
      </div>
      {% endfor %}
    </div>

    <div style="margin-top: 20px; text-align: center; display: flex; gap: 10px; justify-content: center;">
      <button type="submit" class="btn btn-primary" style="padding: 10px 30px; background-color: #0F4F4F; border-color: #0F4F4F; color: white;" onclick="setTimeout(function() { location.reload(); }, 500);">Submit Attendance</button>
      <button type="button" class="btn btn-secondary" style="padding: 10px 30px; background-color: #ff6b6b; border-color: #ff6b6b; color: white;" onclick="clearAllAttendance();">Clear All</button>
    </div>
    {% else %}
    <p class="alert alert-warning">No active employees found.</p>
    {% endif %}
  </form>
</div>
{% else %}
<div class="alert alert-warning">No current session found. Please set a current session in Admin > Sessions.</div>
{% endif %}

<style>
  .attendance-rally-table {
    margin: 20px 0;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
  }

  .attendance-header {
    display: grid;
    grid-template-columns: 3fr 1fr 1fr 1fr;
    background-color: #f5f5f5;
    font-weight: bold;
    padding: 10px;
    border-bottom: 2px solid #ddd;
    gap: 10px;
    align-items: center;
  }

  .attendance-row {
    display: grid;
    grid-template-columns: 3fr 1fr 1fr 1fr;
    padding: 10px;
    border-bottom: 1px solid #eee;
    gap: 10px;
    align-items: center;
    transition: background-color 0.3s ease;
  }

  .attendance-row:last-child {
    border-bottom: none;
  }

  .attendance-row:nth-child(odd) {
    background-color: #fafafa;
  }

  .attendance-row.absent-row {
    background-color: #ffe6e6 !important;
  }

  .emp-name {
    display: flex;
    flex-direction: column;
  }

  .emp-name small {
    color: #666;
    font-weight: normal;
    font-size: 0.85em;
  }

  .emp-attendance {
    text-align: center;
  }

  .emp-attendance input[type="radio"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  @media (max-width: 768px) {
    .attendance-rally-table {
      font-size: 14px;
    }

    .attendance-header, .attendance-row {
      grid-template-columns: 1fr 1fr;
      gap: 5px;
    }

    .emp-name {
      grid-column: 1 / 2;
    }

    .emp-attendance {
      grid-column: 2 / 3;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 5px;
    }
  }
</style>

<script>
function updateRowColor(employeeId) {
  const row = document.getElementById('row_' + employeeId);
  const absentRadio = document.getElementById('absent_' + employeeId);
  
  if (absentRadio.checked) {
    row.classList.add('absent-row');
  } else {
    row.classList.remove('absent-row');
  }
}

function clearAllAttendance() {
  const radios = document.querySelectorAll('input[type="radio"]');
  radios.forEach(radio => {
    radio.checked = false;
  });
  
  // Remove all absent-row classes
  const rows = document.querySelectorAll('.attendance-row');
  rows.forEach(row => {
    row.classList.remove('absent-row');
  });
}

// Initialize row colors on page load
document.addEventListener('DOMContentLoaded', function() {
  const radios = document.querySelectorAll('input[type="radio"]');
  radios.forEach(radio => {
    const match = radio.id.match(/absent_(\d+)/);
    if (match) {
      const employeeId = match[1];
      if (radio.checked) {
        document.getElementById('row_' + employeeId).classList.add('absent-row');
      }
    }
  });
});
</script>

{% endblock %}
